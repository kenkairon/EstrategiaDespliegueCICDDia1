name: Airflow CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  test:
    name: ğŸ§ª Test DAGs
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libpq-dev
    
    - name: ğŸ’¾ Cache de pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“¦ Instalar Apache Airflow (sin extras problemÃ¡ticos)
      run: |
        pip install --upgrade pip setuptools wheel
        
        # Instalar Airflow sin google-re2 y otras dependencias problemÃ¡ticas
        CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-2.7.0/constraints-3.9.txt"
        pip install "apache-airflow==2.7.0" --constraint "${CONSTRAINT_URL}"
    
    - name: ğŸ“¦ Instalar dependencias de testing
      run: |
        pip install pytest pytest-cov
    
    - name: âœ… Validar sintaxis de DAGs
      run: |
        python -c "
        from airflow.models import DagBag
        dagbag = DagBag(dag_folder='dags/', include_examples=False)
        if dagbag.import_errors:
            print('âŒ ERRORES EN DAGs:', dagbag.import_errors)
            exit(1)
        print(f'âœ… {len(dagbag.dags)} DAGs cargados correctamente')
        for dag_id in dagbag.dag_ids:
            print(f'   - {dag_id}')
        "
    
    - name: ğŸ§ª Ejecutar tests
      run: |
        pytest tests/dags/ -v --cov=dags --cov-report=xml --cov-report=term
    
    - name: ğŸ“Š Mostrar resumen de cobertura
      run: |
        echo "ğŸ“Š Resumen de cobertura:"
        coverage report

  deploy-dev:
    name: ğŸš€ Deploy a Dev
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy a Development
      run: |
        echo "ğŸ”§ Desplegando a ambiente de desarrollo..."
        echo "ğŸ“ DAGs encontrados:"
        ls -la dags/
        echo "âœ… Deployment exitoso a DEV"

  deploy-prod:
    name: ğŸ¯ Deploy a ProducciÃ³n
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ¯ Deploy a Production
      run: |
        echo "ğŸš€ Desplegando a producciÃ³n..."
        echo "ğŸ“ DAGs a desplegar:"
        ls -la dags/
        echo "âœ… Deployment a producciÃ³n exitoso"